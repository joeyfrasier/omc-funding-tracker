<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Worksuite — OMC Funding Reconciliation</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700;900&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --ws-orange: #FF4821;
    --ws-maroon: #761900;
    --ws-black: #000000;
    --ws-white: #FFFFFF;
    --ws-lavender: #EEEBFF;
    --ws-mint: #C8EDD5;
    --ws-purple: #5032A0;
    --ws-green: #006032;
    --ws-gray: #DDE3EB;
    --ws-gold: #E1B347;
    --ws-red: #D32F2F;
    --text: #000000;
    --muted: #52525b;
    --border: #DDE3EB;
    --surface: #F8F8FA;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Archivo', -apple-system, sans-serif; background: var(--ws-white); color: var(--text); line-height: 1.5; }

  /* Header bar */
  .header-bar { background: var(--ws-maroon); color: white; padding: 20px 32px; }
  .header-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
  .header-left { display: flex; align-items: center; gap: 20px; }
  .header-bar h1 { font-size: 22px; font-weight: 600; color: white; }
  .header-bar .subtitle { color: rgba(255,255,255,0.7); font-size: 13px; margin-top: 2px; }
  .header-bar a { color: white; font-size: 14px; text-decoration: none; padding: 8px 20px; border: 1px solid rgba(255,255,255,0.3); border-radius: 999px; transition: background 0.2s; }
  .header-bar a:hover { background: rgba(255,255,255,0.1); }

  .container { max-width: 1400px; margin: 0 auto; padding: 28px 32px; }

  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  @media (max-width: 700px) { .stats { grid-template-columns: repeat(2, 1fr); } }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px 20px; }
  .stat:first-child { background: var(--ws-maroon); border-color: var(--ws-maroon); }
  .stat:first-child .stat-label { color: rgba(255,255,255,0.7); }
  .stat:first-child .stat-value { color: white; }
  .stat-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
  .stat-value { font-size: 26px; font-weight: 700; margin-top: 2px; }
  .stat-value.green { color: var(--ws-green); }
  .stat-value.red { color: var(--ws-red); }
  .stat-value.yellow { color: #b45309; }

  .actions { margin-bottom: 24px; display: flex; gap: 12px; align-items: center; }
  button { background: var(--ws-orange); color: white; border: none; padding: 12px 24px; border-radius: 999px; font-family: 'Archivo'; font-size: 14px; font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
  button:hover { opacity: 0.9; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.secondary { background: white; color: var(--text); border: 1px solid var(--border); border-radius: 999px; }
  button.secondary:hover { background: var(--surface); }
  .status-msg { color: var(--muted); font-size: 13px; }

  .section { margin-bottom: 32px; }
  .section-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 2px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  tr:hover td { background: var(--surface); }

  .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; }
  .badge.matched { background: var(--ws-mint); color: var(--ws-green); }
  .badge.mismatch { background: #FEF3C7; color: #92400E; }
  .badge.notfound { background: #FEE2E2; color: var(--ws-red); }

  .report-card { background: var(--ws-white); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
  .report-header { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .report-header:hover { background: var(--surface); }
  .report-title { font-weight: 700; font-size: 14px; }
  .report-meta { color: var(--muted); font-size: 12px; display: flex; gap: 16px; margin-top: 4px; }
  .report-badges { display: flex; gap: 6px; }
  .report-body { padding: 0 20px 16px; display: none; }
  .report-body.open { display: block; }



  .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--ws-orange); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty { text-align: center; padding: 48px; color: var(--muted); }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }

  .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin: 8px 0; overflow: hidden; display: none; }
  .progress-bar.active { display: block; }
  .progress-fill { height: 100%; background: var(--ws-orange); border-radius: 2px; transition: width 0.3s ease; width: 0%; }
  .step-label { font-size: 12px; color: var(--ws-orange); margin-top: 4px; }

  /* Two-column main grid */
  .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; margin-bottom: 32px; }
  @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

  .section-meta { font-size: 11px; color: var(--muted); font-weight: 400; margin-left: 8px; }

  /* Agencies - primary column */
  .agency-list { display: flex; flex-direction: column; gap: 8px; }
  .agency-card { background: var(--ws-white); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 16px; }
  .agency-card:hover { border-color: var(--ws-orange); }
  .agency-name { font-weight: 600; font-size: 14px; }
  .agency-stats { display: flex; gap: 16px; font-size: 12px; color: var(--muted); }
  .agency-stats .stat-matched { color: var(--ws-green); font-weight: 600; }
  .agency-stats .stat-issues { color: var(--ws-red); font-weight: 600; }
  .agency-value { font-weight: 700; font-size: 14px; font-family: 'SF Mono', 'Fira Code', monospace; }
  .empty-inline { color: var(--muted); font-size: 13px; padding: 24px 0; text-align: center; }

  /* Activity log - secondary column */
  .activity-section { position: sticky; top: 20px; align-self: start; }
  .activity-log { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; max-height: 280px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 10px; line-height: 1.5; }
  .activity-log .log-line { padding: 2px 0; }
  .activity-log .log-time { color: var(--muted); }
  .activity-log .log-info { color: var(--text); }
  .activity-log .log-warn { color: #92400E; }
  .activity-log .log-error { color: var(--ws-red); }
  .log-placeholder { color: var(--muted); font-style: italic; }
</style>
</head>
<body>
<div class="header-bar">
  <div class="header-inner">
    <div class="header-left">
      <img src="/static/logo-white.svg" alt="Worksuite" style="height:22px;">
      <div>
        <h1>OMC Funding Reconciliation</h1>
        <div class="subtitle">Omnicom Pay Run Funding Solution — Match remittance emails against Worksuite pay run data</div>
      </div>
    </div>
    <a href="/processed">View Processed Emails →</a>
  </div>
</div>

<div class="container">
  <!-- Hero stats row -->
  <div class="stats" id="stats">
    <div class="stat"><div class="stat-label">Match Rate</div><div class="stat-value" id="s-rate">—</div></div>
    <div class="stat"><div class="stat-label">Matched</div><div class="stat-value green" id="s-matched">—</div></div>
    <div class="stat"><div class="stat-label">Issues</div><div class="stat-value red" id="s-issues">—</div></div>
    <div class="stat"><div class="stat-label">Total Value</div><div class="stat-value" id="s-value">—</div></div>
  </div>

  <!-- Actions bar -->
  <div class="actions">
    <button id="btn-run" onclick="runReconciliation()">Run Reconciliation</button>
    <button class="secondary" onclick="runReconciliation(true)">Re-run (incl. processed)</button>
    <button class="secondary" onclick="loadStatus()">Refresh</button>
    <span class="status-msg" id="status-msg"></span>
  </div>
  <div class="progress-bar" id="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  <div class="step-label" id="step-label"></div>

  <!-- Two-column layout: Agencies (primary) + Activity (secondary) -->
  <div class="main-grid">
    <div class="section" id="agencies-section">
      <div class="section-title">Agencies <span class="section-meta" id="agencies-meta"></span></div>
      <div class="agency-list" id="agencies">
        <div class="empty-inline">Run reconciliation to see agency breakdown</div>
      </div>
    </div>

    <div class="section activity-section">
      <div class="section-title">Activity <span class="section-meta" id="log-count"></span></div>
      <div class="activity-log" id="activity-log"><div class="log-placeholder">Waiting for activity...</div></div>
    </div>
  </div>

  <!-- Reconciliation Reports -->
  <div class="section">
    <div class="section-title">Reconciliation Reports <span class="section-meta" id="s-remittances-label"></span></div>
    <div id="reports"><div class="empty">Click "Run Reconciliation" to fetch and match remittance emails</div></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const fmt = n => n == null ? '—' : '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

function setStatus(msg) { $('status-msg').textContent = msg; }

async function loadStatus() {
  try {
    const r = await fetch('/api/status');
    const d = await r.json();
    updateSummary(d.summary);
    if (d.last_run) setStatus('Last run: ' + new Date(d.last_run).toLocaleString());
    if (d.reports_count > 0) loadReports();
  } catch(e) { setStatus('Error: ' + e.message); }
}

let _activityPoll = null;
let _lastActivityTs = '';

async function runReconciliation(includeProcessed = false) {
  const btn = $('btn-run');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Running...';
  setStatus('Starting reconciliation...');
  $('progress-bar').classList.add('active');
  $('progress-fill').style.width = '5%';
  _lastActivityTs = '';
  _activityPoll = setInterval(pollActivity, 1000);
  try {
    const r = await fetch('/api/run', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({max_emails: 50, include_processed: includeProcessed}) });
    const d = await r.json();
    if (d.success) {
      const msg = d.message || `Done! ${d.emails_fetched} emails, ${d.remittances_parsed} remittances parsed, ${d.reports} reports generated.`;
      setStatus(msg);
      updateSummary(d.summary);
      if (d.reports > 0) loadReports();
      $('progress-fill').style.width = '100%';
      $('step-label').textContent = '✓ Complete';
    } else {
      setStatus('Error: ' + d.error);
      $('step-label').textContent = '✗ Failed: ' + d.error;
    }
  } catch(e) {
    setStatus('Error: ' + e.message);
    $('step-label').textContent = '✗ Error: ' + e.message;
  }
  setTimeout(() => { pollActivity(); clearInterval(_activityPoll); }, 1500);
  btn.disabled = false;
  btn.textContent = 'Run Reconciliation';
  setTimeout(() => { $('progress-bar').classList.remove('active'); }, 3000);
}

async function pollActivity() {
  try {
    const r = await fetch('/api/activity?since=' + encodeURIComponent(_lastActivityTs));
    const entries = await r.json();
    if (entries.length === 0) return;
    const log = $('activity-log');
    if (log.querySelector('div[style]')) log.innerHTML = '';
    for (const e of entries) {
      const cls = e.level === 'ERROR' ? 'log-error' : e.level === 'WARNING' ? 'log-warn' : 'log-info';
      const div = document.createElement('div');
      div.className = 'log-line';
      div.innerHTML = `<span class="log-time">${e.ts.slice(11,19)}</span> <span class="${cls}">${escHtml(e.message)}</span>`;
      log.appendChild(div);
      _lastActivityTs = e.ts;
    }
    log.scrollTop = log.scrollHeight;
    $('log-count').textContent = `(${log.children.length} entries)`;
    const sr = await fetch('/api/status');
    const sd = await sr.json();
    if (sd.run_in_progress) {
      $('progress-fill').style.width = sd.run_progress + '%';
      $('step-label').textContent = sd.run_step;
    }
  } catch(e) { /* ignore */ }
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function updateSummary(s) {
  if (!s) return;
  $('s-matched').textContent = s.matched;
  $('s-issues').textContent = (s.mismatched || 0) + (s.not_found || 0);
  $('s-rate').textContent = s.match_rate || '—';
  $('s-value').textContent = fmt(s.total_remittance_value);
  $('s-remittances-label').textContent = s.total_remittances ? `(${s.total_remittances} remittances, ${s.total_lines} lines)` : '';
  
  if (s.agencies && s.agencies.length) {
    $('agencies-meta').textContent = `(${s.agencies.length} agencies)`;
    $('agencies').innerHTML = s.agencies.map(a => `
      <div class="agency-card">
        <div class="agency-name">${a.name}</div>
        <div class="agency-stats">
          <span>${a.remittances} remittance${a.remittances!=1?'s':''}</span>
          <span class="stat-matched">${a.matched} matched</span>
          ${a.issues ? `<span class="stat-issues">${a.issues} issues</span>` : ''}
        </div>
        <div class="agency-value">${fmt(a.total)}</div>
      </div>
    `).join('');
  } else {
    $('agencies-meta').textContent = '';
    $('agencies').innerHTML = '<div class="empty-inline">Run reconciliation to see agency breakdown</div>';
  }
}

async function loadReports() {
  try {
    const r = await fetch('/api/reports');
    const reports = await r.json();
    if (!reports.length) { $('reports').innerHTML = '<div class="empty">No reports yet</div>'; return; }
    $('reports').innerHTML = reports.map((rpt, i) => {
      const matchBadge = `<span class="badge matched">${rpt.matched} matched</span>`;
      const issueBadges = (rpt.mismatched ? `<span class="badge mismatch">${rpt.mismatched} mismatch</span>` : '') +
                          (rpt.not_found ? `<span class="badge notfound">${rpt.not_found} not found</span>` : '');
      return `<div class="report-card">
        <div class="report-header" onclick="toggle(${i})">
          <div>
            <div class="report-title">${rpt.agency || rpt.subject || 'Unknown'}</div>
            <div class="report-meta">
              <span>${rpt.source}</span>
              <span>Account: ${rpt.account}</span>
              <span>Date: ${rpt.date}</span>
              <span>${fmt(rpt.total)}</span>
              <span>${rpt.total_lines} lines</span>
            </div>
          </div>
          <div class="report-badges">${matchBadge}${issueBadges}</div>
        </div>
        <div class="report-body" id="rb-${i}">
          <table>
            <tr><th>NVC Code</th><th>Contractor</th><th>Company</th><th>Remit Amt</th><th>DB Amt</th><th>Diff</th><th>Status</th><th>Tenant</th><th>Notes</th></tr>
            ${rpt.matches.map(m => `<tr>
              <td class="mono">${m.nvc_code}</td>
              <td>${m.description}</td>
              <td>${m.company}</td>
              <td class="mono">${fmt(m.remittance_amount)}</td>
              <td class="mono">${m.db_amount != null ? fmt(m.db_amount) : '—'}</td>
              <td class="mono" style="color:${!m.difference ? '' : m.difference > 0 ? '#92400E' : 'var(--ws-red)'}">${m.difference != null ? (m.difference > 0 ? '+' : '') + m.difference.toFixed(2) : ''}</td>
              <td><span class="badge ${m.status === 'matched' ? 'matched' : m.status === 'not_in_db' ? 'notfound' : 'mismatch'}">${m.status}</span></td>
              <td>${m.tenant}</td>
              <td style="font-size:11px">${m.notes}</td>
            </tr>`).join('')}
          </table>
        </div>
      </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

function toggle(i) { document.getElementById('rb-' + i).classList.toggle('open'); }
loadStatus();
pollActivity();
</script>
</body>
</html>
