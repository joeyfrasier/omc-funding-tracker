<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMC Funding Reconciliation</title>
<style>
  :root { --bg: #09090b; --surface: #111113; --border: #27272a; --text: #fafafa; --muted: #71717a; --accent: #3b82f6; --green: #22c55e; --red: #ef4444; --yellow: #eab308; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
  .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
  .subtitle { color: var(--muted); font-size: 14px; margin-bottom: 32px; }
  
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .stat-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .stat-value.green { color: var(--green); }
  .stat-value.red { color: var(--red); }
  .stat-value.yellow { color: var(--yellow); }
  
  .actions { margin-bottom: 24px; display: flex; gap: 12px; align-items: center; }
  button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
  button:hover { opacity: 0.9; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.secondary { background: var(--surface); border: 1px solid var(--border); }
  .status-msg { color: var(--muted); font-size: 13px; }
  
  .section { margin-bottom: 32px; }
  .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: var(--muted); font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  
  .badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
  .badge.matched { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge.mismatch { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .badge.notfound { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge.issue { background: rgba(239,68,68,0.3); color: var(--red); }
  
  .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
  .report-header { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .report-header:hover { background: rgba(255,255,255,0.02); }
  .report-title { font-weight: 600; font-size: 14px; }
  .report-meta { color: var(--muted); font-size: 12px; display: flex; gap: 16px; margin-top: 4px; }
  .report-badges { display: flex; gap: 6px; }
  .report-body { padding: 0 20px 16px; display: none; }
  .report-body.open { display: block; }
  
  .agency-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
  .agency-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .agency-name { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
  .agency-stats { font-size: 12px; color: var(--muted); }
  .agency-stats span { margin-right: 12px; }
  
  .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .empty { text-align: center; padding: 48px; color: var(--muted); }
  .mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
</style>
</head>
<body>
<div class="container">
  <h1>OMC Funding Reconciliation</h1>
  <p class="subtitle">Omnicom Pay Run Funding Solution — Match remittance emails against Worksuite pay run data</p>
  
  <div class="stats" id="stats">
    <div class="stat"><div class="stat-label">Remittances</div><div class="stat-value" id="s-remittances">—</div></div>
    <div class="stat"><div class="stat-label">Total Lines</div><div class="stat-value" id="s-lines">—</div></div>
    <div class="stat"><div class="stat-label">Matched</div><div class="stat-value green" id="s-matched">—</div></div>
    <div class="stat"><div class="stat-label">Issues</div><div class="stat-value red" id="s-issues">—</div></div>
    <div class="stat"><div class="stat-label">Match Rate</div><div class="stat-value" id="s-rate">—</div></div>
    <div class="stat"><div class="stat-label">Total Value</div><div class="stat-value" id="s-value">—</div></div>
  </div>
  
  <div class="actions">
    <button id="btn-run" onclick="runReconciliation()">Run Reconciliation</button>
    <button class="secondary" onclick="loadStatus()">Refresh Status</button>
    <span class="status-msg" id="status-msg"></span>
  </div>
  
  <div class="section" id="agencies-section" style="display:none">
    <div class="section-title">Agencies</div>
    <div class="agency-list" id="agencies"></div>
  </div>
  
  <div class="section">
    <div class="section-title">Reconciliation Reports</div>
    <div id="reports"><div class="empty">Click "Run Reconciliation" to fetch and match remittance emails</div></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const fmt = n => n == null ? '—' : '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

function setStatus(msg) { $('status-msg').textContent = msg; }

async function loadStatus() {
  try {
    const r = await fetch('/api/status');
    const d = await r.json();
    updateSummary(d.summary);
    if (d.last_run) setStatus('Last run: ' + new Date(d.last_run).toLocaleString());
    if (d.reports_count > 0) loadReports();
  } catch(e) { setStatus('Error: ' + e.message); }
}

async function runReconciliation() {
  const btn = $('btn-run');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Running...';
  setStatus('Fetching emails, parsing CSVs, matching against DB...');
  
  try {
    const r = await fetch('/api/run', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({max_emails: 50}) });
    const d = await r.json();
    if (d.success) {
      setStatus(`Done! ${d.emails_fetched} emails, ${d.remittances_parsed} remittances parsed, ${d.reports} reports generated.`);
      updateSummary(d.summary);
      loadReports();
    } else {
      setStatus('Error: ' + d.error);
    }
  } catch(e) { setStatus('Error: ' + e.message); }
  
  btn.disabled = false;
  btn.textContent = 'Run Reconciliation';
}

function updateSummary(s) {
  if (!s) return;
  $('s-remittances').textContent = s.total_remittances;
  $('s-lines').textContent = s.total_lines;
  $('s-matched').textContent = s.matched;
  $('s-issues').textContent = (s.mismatched || 0) + (s.not_found || 0);
  $('s-rate').textContent = s.match_rate || '—';
  $('s-value').textContent = fmt(s.total_remittance_value);
  
  if (s.agencies && s.agencies.length) {
    $('agencies-section').style.display = '';
    $('agencies').innerHTML = s.agencies.map(a => `
      <div class="agency-card">
        <div class="agency-name">${a.name}</div>
        <div class="agency-stats">
          <span>${a.remittances} remittance${a.remittances!=1?'s':''}</span>
          <span>${fmt(a.total)}</span>
          <span style="color:var(--green)">${a.matched} matched</span>
          ${a.issues ? `<span style="color:var(--red)">${a.issues} issues</span>` : ''}
        </div>
      </div>
    `).join('');
  }
}

async function loadReports() {
  try {
    const r = await fetch('/api/reports');
    const reports = await r.json();
    if (!reports.length) { $('reports').innerHTML = '<div class="empty">No reports yet</div>'; return; }
    
    $('reports').innerHTML = reports.map((rpt, i) => {
      const matchBadge = `<span class="badge matched">${rpt.matched} matched</span>`;
      const issueBadges = (rpt.mismatched ? `<span class="badge mismatch">${rpt.mismatched} mismatch</span>` : '') +
                          (rpt.not_found ? `<span class="badge notfound">${rpt.not_found} not found</span>` : '');
      
      return `<div class="report-card">
        <div class="report-header" onclick="toggle(${i})">
          <div>
            <div class="report-title">${rpt.agency || rpt.subject || 'Unknown'}</div>
            <div class="report-meta">
              <span>${rpt.source}</span>
              <span>Account: ${rpt.account}</span>
              <span>Date: ${rpt.date}</span>
              <span>${fmt(rpt.total)}</span>
              <span>${rpt.total_lines} lines</span>
            </div>
          </div>
          <div class="report-badges">${matchBadge}${issueBadges}</div>
        </div>
        <div class="report-body" id="rb-${i}">
          <table>
            <tr><th>NVC Code</th><th>Contractor</th><th>Company</th><th>Remit Amt</th><th>DB Amt</th><th>Diff</th><th>Status</th><th>Tenant</th><th>Notes</th></tr>
            ${rpt.matches.map(m => `<tr>
              <td class="mono">${m.nvc_code}</td>
              <td>${m.description}</td>
              <td>${m.company}</td>
              <td class="mono">${fmt(m.remittance_amount)}</td>
              <td class="mono">${m.db_amount != null ? fmt(m.db_amount) : '—'}</td>
              <td class="mono" style="color:${!m.difference ? '' : m.difference > 0 ? 'var(--yellow)' : 'var(--red)'}">${m.difference != null ? (m.difference > 0 ? '+' : '') + m.difference.toFixed(2) : ''}</td>
              <td><span class="badge ${m.status === 'matched' ? 'matched' : m.status === 'not_in_db' ? 'notfound' : 'mismatch'}">${m.status}</span></td>
              <td>${m.tenant}</td>
              <td style="font-size:11px">${m.notes}</td>
            </tr>`).join('')}
          </table>
        </div>
      </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

function toggle(i) {
  const el = document.getElementById('rb-' + i);
  el.classList.toggle('open');
}

loadStatus();
</script>
</body>
</html>
